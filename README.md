
# Multivariate functional principal component analysis on high dimensional gait data

![gait_cycle-2](https://user-images.githubusercontent.com/72037180/120051152-6539ce00-c017-11eb-9de6-6d3547242e7c.png)

## Overview

MFPCA: Multivariate Functional Principal Component Analysis is an R package that provides analysis of high dimensional data observed on different dimensional domains. The estimation algorithm calculates multivariate functional principal components and scores based on their univariate counterparts see [(Happ & Greven, 2018)](https://doi.org/10.1080%2F01621459.2016.1273115) for more information. Additionally see [(Rpackage: MFPCA)](https://cran.r-project.org/web/packages/MFPCA/index.html) for details about the R package.

## Installation

```r
# Install from CRAN
install.packages("MFPCA")

# After installing load the library
library(MFPCA)
```

## Introduction
The dataset is available from this [website](https://wwrichard.net/resources/gps-map-and-gdi-calculators/). An excel file named as gdi-gps-calculator-v-3-2.xlsx contains the data of the subjects having gait abnormality termed as Subject Kinematics in excel sheets and without gait abnormality as Control Kinematics. It contains the movement on nine kinematic variables collected from 48 children, 6 children of which had cerebral palsy. For each child, measurements on nine kinematic variables on each leg representing the movement of :
<ul>
<li>the pelvis in left-right direction, forward-backward direction and upward-downward direction,</li>
<li>the hip in left-right direction, forward-backward direction and upward-downward direction,</li>
<li>the knee in left-right direction,</li>
<li>the ankle in left-right direction,</li>
<li>and the footprogression in left-right direction.</li>
</ul>
were recorded over the entire gait cycle ranging over 51-time points. The gait cycle is measured from heel-strike to heel-strike (i.e. when one-foot contacts the ground to when that same foot again contacts the ground again) as shown in above Figure. The data exhibits considerably different gait patterns over the different kinematic variables as well as large variation among subjects. The data which is used as an example for this study can be found in `Data.R` file which is stored in the format for the study.


#### Aim of this work
 <ul>
<li> Need to calculate the amount by which a subject's gait deviates from an average normal profile and to represent this deviation as a single number.</li>
<li> Such a measure can quantify the overall severity of a condition affecting walking, monitor progress, or to evaluate the outcome of an intervention prescribed to improve the gait pattern.</li>
</ul>

## Functional GDI (FGDI)
Multivariate functional data typically comprises of several recorded time course measurements for a sample of subjects. The term functional refers to the intrinsic structure of the data, i.e., the belief that for each subject the angular movement at each joint/direction, <img src="https://render.githubusercontent.com/render/math?math=%24j%3D1%2C%5Cldots%2CQ%24"> (where <img src="https://render.githubusercontent.com/render/math?math=%24Q%24"> is the number of movements recorded at each direction for each joint), which are being generated by some underlying function <img src="https://render.githubusercontent.com/render/math?math=%24X_%7Bj%7D%24"> and the discrete measurements collected <img src="https://render.githubusercontent.com/render/math?math=%24X_%7B1%7D(t_1)%2C%5Cldots%2CX_%7BQ%7D(t_%7BN%7D)%24"> are a snapshot of that function at various points in time <img src="https://render.githubusercontent.com/render/math?math=%24t_1%2C%5Cldots%2Ct_N%24">. 
Here we use MFPCA attributable to [MFPCA](https://doi.org/10.1080%2F01621459.2016.1273115) to determine the main modes of variation in the overall gait movement. MFPCA produces a multivariate functional Karhunen-Lo\'eve representation of the data, <br>

<img src="https://render.githubusercontent.com/render/math?math=%5Chat%7BX%7D_%7Bj%7D(t)%20%5Capprox%20%5Chat%7B%5Cmu%7D_%7Bj%7D(t)%2B%5Csum_%7Bw%3D1%7D%5E%7BW%7D%20%5Chat%7B%5Crho%7D_%7Bw%7D%5Chat%7B%5Cpsi%7D%5E%7B(j)%7D_%7Bw%7D(t)%2C"> <br>

where <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Cmu%7D_%7Bj%7D(t)%24"> is an estimate of the mean function for the <img src="https://render.githubusercontent.com/render/math?math=%24j%5E%7Bth%7D%24"> joint/direction across all subjects, <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Crho%7D_%7Bw%7D%24"> is the <img src="https://render.githubusercontent.com/render/math?math=%24w%5E%7Bth%7D%24"> principal component score and <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Cpsi%7D%5E%7B(j)%7D_%7Bw%7D(t)%24"> is the <img src="https://render.githubusercontent.com/render/math?math=%24w%5E%7Bth%7D%24"> principal component function for the <img src="https://render.githubusercontent.com/render/math?math=%24j%5E%7Bth%7D%24"> joint/direction. The number of principal components <img src="https://render.githubusercontent.com/render/math?math=%24W%24"> is determined by the percentage of variance explained. <br>

#### Multivariate functional principal component analysis (MFPCA) steps:

1. Calculate a univariate FPCA for each joint/direction <img src="https://render.githubusercontent.com/render/math?math=%24j%3D1%2C%5Cldots%2CQ%24">. This results in principal component functions <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Cphi%7D%5E%7Bj%7D_1%2C%5Cldots%2C%5Chat%7B%5Cphi%7D%5E%7Bj%7D_%7BK_j%7D%24"> and principal component scores <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Cxi%7D%5E%7Bj%7D_1%2C%5Cldots%2C%5Chat%7B%5Cxi%7D%5E%7Bj%7D_%7BK_j%7D%24">, for each subject <img src="https://render.githubusercontent.com/render/math?math=%24i%3D1%2C%5Cldots%2CM%24"> with suitably chosen truncation lags <img src="https://render.githubusercontent.com/render/math?math=%24K_j%24">.  <br>

2. Combine all coefficients into one big matrix <img src="https://render.githubusercontent.com/render/math?math=%24%5CXi%20%5Cin%20%5Cmathbb%7BR%7D%5E%7BM%20%5Ctimes%20K_%7B%2B%7D%7D%24"> with <img src="https://render.githubusercontent.com/render/math?math=%24K_%7B%2B%7D%3DK_1%2C%5Cldots%2CK_Q%2C%24"> having rows <br> 
<img src="https://render.githubusercontent.com/render/math?math=%5CXi_%7Bi%7D%3D(%5Chat%7B%5Cxi%7D%5E%7Bi%2C1%7D_1%2C%5Cldots%2C%5Chat%7B%5Cxi%7D%5E%7Bi%2C1%7D_%7BK_1%7D%2C%5Cldots%2C%5Chat%7B%5Cxi%7D%5E%7Bi%2CQ%7D_1%2C%5Cldots%2C%5Chat%7B%5Cxi%7D%5E%7Bi%2CQ%7D_%7BK_Q%7D)">, and estimate the joint covariance matrix <img src="https://render.githubusercontent.com/render/math?math=%5Chat%7BZ%7D%3D%5Cfrac%7B1%7D%7BM-1%7D%5CXi%5E%7BT%7D%5CXi.">. 

3. Find eigenvectors <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7Bc%7D_%7Bw%7D%24"> and eigenvalues <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Cnu%7D_%7Bw%7D%24"> of <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7BZ%7D%24"> for <img src="https://render.githubusercontent.com/render/math?math=%24w%3D1%2C%5Cldots%2CW%2C%24"> for some truncation lag <img src="https://render.githubusercontent.com/render/math?math=%24W%3CK_%7B%2B%7D%24">. <br>

4. Calculate the estimated multivariate principal component functions <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Cpsi%7D_%7Bw%7D%24"> and scores <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Crho%7D_%7Bi%2Cw%7D%24"> based on the results from steps 1 and 3:  <br> 
<img src="https://render.githubusercontent.com/render/math?math=%5Chat%7B%5Cpsi%7D%5E%7B(j)%7D_%7Bw%7D%3D%5Csum_%7Bk%3D1%7D%5E%7BK_%7Bj%7D%7D%5B%5Chat%7Bc%7D_%7Bw%7D%5D_%7Bk%7D%5E%7B(j)%7D%5Chat%7B%5Cphi%7D%5E%7B(j)%7D_k%2C%20%5Cquad%20%5Cmbox%7Band%7D%20%5Cquad%20%5Chat%7B%5Crho%7D_%7Bi%2Cw%7D%3D%5Csum_%7Bj%3D1%7D%5E%7BQ%7D%5Csum_%7Bk%3D1%7D%5E%7BK_%7Bj%7D%7D%5B%5Chat%7Bc%7D_%7Bw%7D%5D_%7Bk%7D%5E%7B(j)%7D%5Chat%7B%5Cxi%7D%5E%7Bi%2Cj%7D_k%2C%20%5Cquad%20%5Cmbox%7Bfor%7D%20%5Cquad%20j%3D1%2C%5Cldots%2CQ">.

After applying MFPCA algorithm, the proposed index evaluates the Euclidean distance between the principal component scores of a subject with gait abnormalities, relative to the average principal component scores of all subjects without gait abnormalities. First calculate the average of the principal component scores of all subjects without gait abnormalities <img src="https://render.githubusercontent.com/render/math?math=%24%5Cbar%7B%5Cboldsymbol%7B%5Chat%7B%5Crho%7D%7D%7D_%7Bw%7D%5E%7B(Control)%7D%24">. Calculate the Euclidean distance from the <img src="https://render.githubusercontent.com/render/math?math=%24w%5E%7Bth%7D%24"> principal component score for the <img src="https://render.githubusercontent.com/render/math?math=%24i%5E%7Bth%7D%24"> subject, <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Crho%7D_%7Bi%2Cw%7D%24">, to the average <img src="https://render.githubusercontent.com/render/math?math=%24w%5E%7Bth%7D%24"> principal component scores of all subjects without gait abnormalities <img src="https://render.githubusercontent.com/render/math?math=%24%5Cbar%7B%5Cboldsymbol%7B%5Chat%7B%5Crho%7D%7D%7D_%7Bw%7D%5E%7B(Control)%7D%24">, which we denote by <img src="https://render.githubusercontent.com/render/math?math=d_%7Bi%2Cw%7D%20%3D%20%5C%7C(%5Chat%7B%5Crho%7D_%7Bi%2Cw%7D-%5Cbar%7B%5Chat%7B%5Crho%7D%7D_%7Bw%7D%5E%7B(Control)%7D%5C%7C">.

This measure can be used in its raw format as a measure of pathology. To improve interpretation the functional GDI can be scaled. To ensure that the distances for the different principal components are on a comparable scale we divide the distances <img src="https://render.githubusercontent.com/render/math?math=%24d_%7Bi%2Cw%7D%24"> by <img src="https://render.githubusercontent.com/render/math?math=%24%5Ctextrm%7Bmax%7D(%5Ctextrm%7Bd%7D_%7Bw%7D)%2C%24"> the maximum distance across all subjects in component <img src="https://render.githubusercontent.com/render/math?math=%24w%2C%24">this produces a scaled distance <img src="https://render.githubusercontent.com/render/math?math=%5Cdelta_%7Bi%2Cw%7D%3D%5Cfrac%7Bd_%7Bi%2Cw%7D%7D%7B%5Ctextrm%7Bmax%7D(%5Ctextrm%7Bd%7D_%7Bw%7D)%7D%24">. The proposed functional gait deviation index for subject <img src="https://render.githubusercontent.com/render/math?math=%24i%24"> is then given by the logarithm of the square root of the sum of the scaled distances <img src="https://render.githubusercontent.com/render/math?math=%24%5Ctextrm%7BFGDI%7D_%7Bi%7D%3Dlog%20%5Cleft(%20%5Csqrt%7B%5Csum_%7Bw%3D1%7D%5E%7BW%7D%20%5Cdelta_%7Bi%2Cw%7D%7D%20%5Cright)%2C%24"> where <img src="https://render.githubusercontent.com/render/math?math=%24W%24"> is the number of principal components. The functional GDI index is bounded between 0 and 1, where 0 indicates no deviation from the average normal profile and 1 represents a subject exhibiting the largest deviation from the average normal profile for all components <img src="https://render.githubusercontent.com/render/math?math=%24w%3D1%2C%5Cldots%2CW%24"> and all kinematic variables <img src="https://render.githubusercontent.com/render/math?math=%24j%3D1%2C%5Cldots%2CQ%24">.

## Functions

#### `Readexcel.R`:
file contains the function read_excel_allsheets(name of the file) which takes the whole excel file and read the individual excel sheets

#### `New_GDI_Index.R`:
GDI_new(G=data, ID=label whether it is a case or control, NPC= no. of univarite PC’s for each individual curve, Mval= no. of PC’s) calculates the index for each subject which tells how severe the abnormality of the person is if the Index is 0 means no abnormality and if it is 1 it denotes severe abnormality. Such a measure can quantify the overall severity of a condition affecting walking, monitor progress, or to evaluate the outcome of an intervention prescribed to improve the gait pattern.



## Tutorial on how to use the above files to calculate the index

1. First, the data should be in exact format as the it’s `Data.R` file.
2. Then we calculate the univarite PC’s for each of them separately in the `Main.R` file.
3. After calculating univariate PC’s, we make a vector that stores all the PC’s of each joint for both legs.
4. Then run the function GDI_new() and get the index for all the subjects. For the ease multiply the index by 100 so that the scale of the index is between 0 to 100, where 0 means no abnormality and 100 means most abnormal behaviour.

