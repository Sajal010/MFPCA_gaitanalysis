
# Multivariate functional principal component analysis on high dimensional gait data

![gait_cycle-2](https://user-images.githubusercontent.com/72037180/120051152-6539ce00-c017-11eb-9de6-6d3547242e7c.png)

## Overview

MFPCA: Multivariate Functional Principal Component Analysis is an R package that provides analysis of high dimensional data observed on different dimensional domains. The estimation algorithm calculates multivariate functional principal components and scores based on their univariate counterparts see [(Happ & Greven, 2018)](https://doi.org/10.1080%2F01621459.2016.1273115) for more information. Additionally see [(Rpackage: MFPCA)](https://cran.r-project.org/web/packages/MFPCA/index.html) for details about the R package.

## Installation

```r
# Install from CRAN
install.packages("MFPCA")

# After installing load the library
library(MFPCA)
```

## Introduction
The dataset is available from this [website](https://wwrichard.net/resources/gps-map-and-gdi-calculators/). An excel file named as gdi-gps-calculator-v-3-2.xlsx contains the data of the subjects having gait abnormality termed as Subject Kinematics in excel sheets and without gait abnormality as Control Kinematics. It contains the movement on nine kinematic variables collected from 48 children, 6 children of which had cerebral palsy. For each child, measurements on nine kinematic variables on each leg representing the movement of :
<ul>
<li>the pelvis in left-right direction, forward-backward direction and upward-downward direction,</li>
<li>the hip in left-right direction, forward-backward direction and upward-downward direction,</li>
<li>the knee in left-right direction,</li>
<li>the ankle in left-right direction,</li>
<li>and the footprogression in left-right direction.</li>
</ul>
were recorded over the entire gait cycle ranging over 51-time points. The gait cycle is measured from heel-strike to heel-strike (i.e. when one-foot contacts the ground to when that same foot again contacts the ground again) as shown in above Figure. The data exhibits considerably different gait patterns over the different kinematic variables as well as large variation among subjects. The data which is used as an example for this study can be found in `Data.R` file which is stored in the format for the study.


#### Aim of this work
 <ul>
<li> Need to calculate the amount by which a subject's gait deviates from an average normal profile and to represent this deviation as a single number.</li>
<li> Such a measure can quantify the overall severity of a condition affecting walking, monitor progress, or to evaluate the outcome of an intervention prescribed to improve the gait pattern.</li>
</ul>

## Functional GDI
Multivariate functional data typically comprises of several recorded time course measurements for a sample of subjects. The term functional refers to the intrinsic structure of the data, i.e., the belief that for each subject the angular movement at each joint/direction, <img src="https://render.githubusercontent.com/render/math?math=%24j%3D1%2C%5Cldots%2CQ%24"> (where <img src="https://render.githubusercontent.com/render/math?math=%24Q%24"> is the number of movements recorded at each direction for each joint), which are being generated by some underlying function <img src="https://render.githubusercontent.com/render/math?math=%24X_%7Bj%7D%24"> and the discrete measurements collected <img src="https://render.githubusercontent.com/render/math?math=%24X_%7B1%7D(t_1)%2C%5Cldots%2CX_%7BQ%7D(t_%7BN%7D)%24"> are a snapshot of that function at various points in time <img src="https://render.githubusercontent.com/render/math?math=%24t_1%2C%5Cldots%2Ct_N%24">. 
Here we use MFPCA attributable to [MFPCA](https://doi.org/10.1080%2F01621459.2016.1273115) to determine the main modes of variation in the overall gait movement. MFPCA produces a multivariate functional Karhunen-Lo\'eve representation of the data, <br>

<img src="https://render.githubusercontent.com/render/math?math=%5Chat%7BX%7D_%7Bj%7D(t)%20%5Capprox%20%5Chat%7B%5Cmu%7D_%7Bj%7D(t)%2B%5Csum_%7Bw%3D1%7D%5E%7BW%7D%20%5Chat%7B%5Crho%7D_%7Bw%7D%5Chat%7B%5Cpsi%7D%5E%7B(j)%7D_%7Bw%7D(t)%2C"> <br>

where <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Cmu%7D_%7Bj%7D(t)%24"> is an estimate of the mean function for the <img src="https://render.githubusercontent.com/render/math?math=%24j%5E%7Bth%7D%24"> joint/direction across all subjects, <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Crho%7D_%7Bw%7D%24"> is the <img src="https://render.githubusercontent.com/render/math?math=%24w%5E%7Bth%7D%24"> principal component score and <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Cpsi%7D%5E%7B(j)%7D_%7Bw%7D(t)%24"> is the <img src="https://render.githubusercontent.com/render/math?math=%24w%5E%7Bth%7D%24"> principal component function for the <img src="https://render.githubusercontent.com/render/math?math=%24j%5E%7Bth%7D%24"> joint/direction. The number of principal components <img src="https://render.githubusercontent.com/render/math?math=%24W%24"> is determined by the percentage of variance explained. <br>

#### Multivariate functional principal component analysis (MFPCA) steps:

1. Calculate a univariate FPCA for each joint/direction <img src="https://render.githubusercontent.com/render/math?math=%24j%3D1%2C%5Cldots%2CQ%24">. This results in principal component functions <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Cphi%7D%5E%7Bj%7D_1%2C%5Cldots%2C%5Chat%7B%5Cphi%7D%5E%7Bj%7D_%7BK_j%7D%24"> and principal component scores <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Cxi%7D%5E%7Bj%7D_1%2C%5Cldots%2C%5Chat%7B%5Cxi%7D%5E%7Bj%7D_%7BK_j%7D%24">, for each subject <img src="https://render.githubusercontent.com/render/math?math=%24i%3D1%2C%5Cldots%2CM%24"> with suitably chosen truncation lags <img src="https://render.githubusercontent.com/render/math?math=%24K_j%24">.  <br>

2. Combine all coefficients into one big matrix <img src="https://render.githubusercontent.com/render/math?math=%24%5CXi%20%5Cin%20%5Cmathbb%7BR%7D%5E%7BM%20%5Ctimes%20K_%7B%2B%7D%7D%24"> with <img src="https://render.githubusercontent.com/render/math?math=%24K_%7B%2B%7D%3DK_1%2C%5Cldots%2CK_Q%2C%24"> having rows <br> 
<img src="https://render.githubusercontent.com/render/math?math=%5CXi_%7Bi%7D%3D(%5Chat%7B%5Cxi%7D%5E%7Bi%2C1%7D_1%2C%5Cldots%2C%5Chat%7B%5Cxi%7D%5E%7Bi%2C1%7D_%7BK_1%7D%2C%5Cldots%2C%5Chat%7B%5Cxi%7D%5E%7Bi%2CQ%7D_1%2C%5Cldots%2C%5Chat%7B%5Cxi%7D%5E%7Bi%2CQ%7D_%7BK_Q%7D)">, and estimate the joint covariance matrix <img src="https://render.githubusercontent.com/render/math?math=%5Chat%7BZ%7D%3D%5Cfrac%7B1%7D%7BM-1%7D%5CXi%5E%7BT%7D%5CXi.">. 

3. Find eigenvectors <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7Bc%7D_%7Bw%7D%24"> and eigenvalues <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Cnu%7D_%7Bw%7D%24"> of <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7BZ%7D%24"> for <img src="https://render.githubusercontent.com/render/math?math=%24w%3D1%2C%5Cldots%2CW%2C%24"> for some truncation lag <img src="https://render.githubusercontent.com/render/math?math=%24W%3CK_%7B%2B%7D%24">. <br>

4. Calculate the estimated multivariate principal component functions <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Cpsi%7D_%7Bw%7D%24"> and scores <img src="https://render.githubusercontent.com/render/math?math=%24%5Chat%7B%5Crho%7D_%7Bi%2Cw%7D%24"> based on the results from steps 1 and 3:  <br> 
<img src="https://render.githubusercontent.com/render/math?math=%5Chat%7B%5Cpsi%7D%5E%7B(j)%7D_%7Bw%7D%3D%5Csum_%7Bk%3D1%7D%5E%7BK_%7Bj%7D%7D%5B%5Chat%7Bc%7D_%7Bw%7D%5D_%7Bk%7D%5E%7B(j)%7D%5Chat%7B%5Cphi%7D%5E%7B(j)%7D_k%2C%20%5Cquad%20%5Cmbox%7Band%7D%20%5Cquad%20%5Chat%7B%5Crho%7D_%7Bi%2Cw%7D%3D%5Csum_%7Bj%3D1%7D%5E%7BQ%7D%5Csum_%7Bk%3D1%7D%5E%7BK_%7Bj%7D%7D%5B%5Chat%7Bc%7D_%7Bw%7D%5D_%7Bk%7D%5E%7B(j)%7D%5Chat%7B%5Cxi%7D%5E%7Bi%2Cj%7D_k%2C%20%5Cquad%20%5Cmbox%7Bfor%7D%20%5Cquad%20j%3D1%2C%5Cldots%2CQ">.

## Gait deviation Index (GDI)

[Schwartz and Rozumalski, 2008](https://pubmed.ncbi.nlm.nih.gov/18565753/) introduced the Gait Deviation Index (GDI) is a score derived from 3D time-course movement data which provides a numerical value that expresses overall gait abnormality. Every 10-point decrease in the GDI corresponds to one standard deviation from the mean of healthy controls. It quantifies the difference between data from one gait cycle for a particular individual that has the abnormality and the average of a reference dataset from subjects exhibiting no gait abnormality. The GDI is used extensively to measure gait abnormality in children with cerebral palsy (CP)( [Massaad et al.,  2014](https://pubmed.ncbi.nlm.nih.gov/24079975/), [Molloy et al.,  2010](https://pubmed.ncbi.nlm.nih.gov/20226675/), [ Cimolin et al., 2011](https://pubmed.ncbi.nlm.nih.gov/21075594/) ).  <br> 

1. To calculate GDI, the data was first arranged as gait vectors (<img src="https://render.githubusercontent.com/render/math?math=%5Ctextbf%7Bg%7D">), which includes all the joints/ axis i.e. pelvic and hip angles in all three planes, knee, ankle and foot throughout the entire gait cycle (9 angles x 51 points = 459 datum) separately for each leg side. The gait vectors for each subject will then be 459 x 1 gait vectors (g): <br> 
<img src="https://render.githubusercontent.com/render/math?math=%5Ctextbf%7Bg%7D%20%3D%20%5B%5C%7Bpel%20x%5C%7D%2C%5C%7Bpel%20y%5C%7D%2C......%20%5C%7Bknee%20x%5C%7D%2C%5C%7Bfoot%20x%5C%7D%5D%5ET%20%5C%5C%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Cquad%20%3D%20%5B%5C%7Bg_%7B1-51%7D%5C%7D%2C%5C%7Bg_%7B52-102%7D%5C%7D%2C.....%2C%20%5C%7Bg_%7B358-408%7D%5C%7D%2C%5C%7Bg_%7B409-459%7D%5C%7D%5D%5ET"> <br> 

4. The vectors for every subject side were concatenated to form a 459 x 6 gait matrix <img src="https://render.githubusercontent.com/render/math?math=%5Ctextbf%7BG%7D%3A"> <br> 
<img src="https://render.githubusercontent.com/render/math?math=%5Cbegin%7Bequation%7D%0A%5Ctextbf%7BG%7D%20%3D%20%5Cbegin%7Bbmatrix%7D%0A%0A%5Cbegin%7Bpmatrix%7D%20g%5E%7B1%7D_%7B1%7D%5C%5C%0Ag%5E%7B1%7D_%7B2%7D%5C%5C%0A%5Cvdots%5C%5C%0Ag%5E%7B1%7D_%7B459%7D%20%5Cend%7Bpmatrix%7D%0A%0A%5Cbegin%7Bpmatrix%7D%20g%5E%7B2%7D_%7B1%7D%5C%5C%0Ag%5E%7B2%7D_%7B2%7D%5C%5C%0A%5Cvdots%5C%5C%0Ag%5E%7B2%7D_%7B459%7D%20%5Cend%7Bpmatrix%7D%0A%5Ccdots%0A%5Cbegin%7Bpmatrix%7D%20g%5E%7B6%7D_%7B1%7D%5C%5C%0Ag%5E%7B6%7D_%7B2%7D%5C%5C%0A%5Cvdots%5C%5C%0Ag%5E%7B6%7D_%7B459%7D%20%5Cend%7Bpmatrix%7D%0A%0A%5Cend%7Bbmatrix%7D%0A%5Cend%7Bequation%7D"> <br> 

3. The singular value decomposition (SVD) of <img src="https://render.githubusercontent.com/render/math?math=%5Ctextbf%7BG%7D%0A%0A"> was computed and the unit singular vectors <img src="https://render.githubusercontent.com/render/math?math=%5C%7B%7B%5Chat%7B%5Ctextbf%7Bf%7D%7D_%7B1%7D%2C%20%5Chat%7B%5Ctextbf%7Bf%7D%7D_%7B2%7D%2C%20%5Chat%7B%5Ctextbf%7Bf%7D%7D_%7B3%7D%2C%5Cldots%2C%5Chat%7B%5Ctextbf%7Bf%7D%7D_%7B459%7D%7D%5C%7D%0A"> and the singular values <img src="https://render.githubusercontent.com/render/math?math=%5C%7B%5Clambda_%7B1%7D%2C%20%5Clambda_%7B2%7D%2C%20%5Clambda_%7B2%7D%2C%5Cldots%2C%20%5Clambda_%7B459%7D%5C%7D"> was preserved. These singular vectors are referred as gait vectors, form an orthonormal basis (f-basis) for reconstructing the gait data. The f-basis is optimal in that it maximises the variance accounted for (VAF) using the maximum number of features.

4. Given the f-basis, an mth order approximation of any gait vector can be computed as <img src="https://render.githubusercontent.com/render/math?math=%24%5Cwidetilde%7Bg%7D%5Em%20%3D%20%5Csum_%7BZ%3D1%7D%5E%7Bm%7D%20c_z%20%5Chat%7B%5Ctextbf%7Bf%7D%7D_%7Bz%7D%24">, where <img src="https://render.githubusercontent.com/render/math?math=%24c_z%24"> are the feature components <img src="https://render.githubusercontent.com/render/math?math=c_z%3D%20%5Ctextbf%7Bg%7D%20%5Ccdot%20%5Chat%7B%5Ctextbf%7Bf%7D%7D_%7Bz%7D">
The feature components can be arranged as a vector <img src="https://render.githubusercontent.com/render/math?math=%24c%20%3D%20(c_1%2C%20c_2%2C%20%5Cldots%2Cc_m)%24">, and thought of as the gait vector projected onto the zth feature directions. To choose the value of m for an appropriate reconstruction of the gait data i.e. <img src="https://render.githubusercontent.com/render/math?math=%24m%3D%20m_%7Bcrit%7D%24"> using the overall variation accounted for (VAF) by the first m features. It is quite easily computed as:
<img src="https://render.githubusercontent.com/render/math?math=%24VAF_m%20%3D%5Cfrac%7B%5Csum_%7Bi%3D1%7D%5E%7Bm%7D%5Clambda_%7Bi%7D%5E%7B2%7D%7D%7B%5Csum_%7Bj%3D1%7D%5E%7B459%7D%5Clambda_%7Bj%7D%5E%7B2%7D%7D%24">.

5. Calculating the distance between the control and cases groups using the average of the feature components over the control group as <img src="https://render.githubusercontent.com/render/math?math=%24%5Cbar%7Bc%7D%5E%7Bcontrol%7D%24"> and any subject <img src="https://render.githubusercontent.com/render/math?math=%24c%5Ea%24"> from the cases or control groups. The distance between them is calculated as: <img src="https://render.githubusercontent.com/render/math?math=d%5E%7B%5Ctext%7Ba%2C%20control%7D%7D%20%3D%7C%7C%20c%5E%7B%5Ctext%7Ba%7D%7D%20-%20%5Cbar%7Bc%7D%5E%7B%5Ctext%7Bcontrol%7D%7D%20%7C%7C">.

6. Given the distance between any subject from cases or control groups and the average control, the raw GDI for any subject is calculated as
<img src="https://render.githubusercontent.com/render/math?math=GDI%5E%7B%5Ctext%7Ba%7D%7D_%7B%5Ctext%7Baverage%20control%7D%7D%20%3D%20%5Cln%7B(d%5E%7B%5Ctext%7Ba%2C%20average%20control%7D%7D%7D)%5C%5C%0A%20%20%3D%5Cln%7B%7C%7C%20c%5E%7B%5Ctext%7Ba%7D%7D%20-%20%5Cbar%7Bc%7D%5E%7B%5Ctext%7Bcontrol%7D%7D%20%7C%7C%7D">.

7.  To improve interpretability the GDI is scaled, by calculating sample mean and standard deviation of the <img src="https://render.githubusercontent.com/render/math?math=%24GDI_%7B%5Ctext%7Baverage%20control%7D%7D%5E%7Ba%7D%24"> <img src="https://render.githubusercontent.com/render/math?math=%24(Mean(GDI%5E%7B%5Ctext%7Ba%7D%7D_%7B%5Ctext%7Baverage%20control%7D%7D)%24">,  <img src="https://render.githubusercontent.com/render/math?math=%24S.D.(GDI%5E%7B%5Ctext%7Ba%7D%7D_%7B%5Ctext%7Baverage%20control%7D%7D))%24">. Therefore, a z-score with respect to the control for any subject from cases and control groups was measured as follows:
<img src="https://render.githubusercontent.com/render/math?math=%5Cbegin%7Bequation%7D%0A%20zGDI%5E%7B%5Ctext%7Ba%7D%7D_%7B%5Ctext%7Baverage%20control%7D%7D%20%3D%20%5Cfrac%7B(GDI%5E%7B%5Ctext%7Ba%7D%7D_%7B%5Ctext%7Baverage%20control%7D%7D%20-%20Mean(GDI%5E%7B%5Ctext%7Ba%7D%7D_%7B%5Ctext%7Baverage%20control%7D%7D)%7D%7BS.D.(GDI%5E%7B%5Ctext%7Ba%7D%7D_%7B%5Ctext%7Baverage%20control%7D%7D)%7D%0A%20%20%5Cend%7Bequation%7D">.


8. For ease of interpretation, the z-score was multiplied by 10 and subtracted from 100 i.e.; <img src="https://render.githubusercontent.com/render/math?math=GDI%5E%7B%5Ctext%7Ba%7D%7D_%7B%5Ctext%7Baverage%20control%7D%7D%3D100%20-%20zGDI%5E%7B%5Ctext%7Ba%7D%7D_%7B%5Ctext%7Baverage%20control%7D%7D%20">.

The GDI is mostly useful in application related to feature analysis such as cluster analysis or subject matching. It compares the curves to each other and compute a one point measure i.e., GDI of whole time series curve neglecting the full domain's shape and functional behaviour which can be of utmost importance. Such measure can quantify the overall severity of a condition affecting walking or monitor progress but can't use the entire stride of gait to detect any location or magnitude of difference within the entire gait cycle. Mainly, it is a Quantitative “severity” index - based on kinematics of the gaits.

## Functions

#### `Readexcel.R`:
file contains the function read_excel_allsheets(name of the file) which takes the whole excel file and read the individual excel sheets

#### `New_GDI_Index.R`:
GDI_new(G=data, ID=label whether it is a case or control, NPC= no. of univarite PC’s for each individual curve, Mval= no. of PC’s) calculates the index for each subject which tells how severe the abnormality of the person is if the Index is 0 means no abnormality and if it is 1 it denotes severe abnormality. Such a measure can quantify the overall severity of a condition affecting walking, monitor progress, or to evaluate the outcome of an intervention prescribed to improve the gait pattern.



## Tutorial on how to use the above files to calculate the index

1. First, the data should be in exact format as the it’s `Data.R` file.
2. Then we calculate the univarite PC’s for each of them separately in the `Main.R` file.
3. After calculating univariate PC’s, we make a vector that stores all the PC’s of each joint for both legs.
4. Then run the function GDI_new() and get the index for all the subjects. For the ease multiply the index by 100 so that the scale of the index is between 0 to 100, where 0 means no abnormality and 100 means most abnormal behaviour.

